#summary Summary of the upload protocol.

= Upload protocol =

I will summarize here my understanding of the protocol that the Eye-Fi cards are using to upload images to the server. This information is incomplete because it was mainly obtained by reverse-engineering.

The protocol is based on SOAP/HTTP. The commands are sent by the Eye-Fi card as HTTP POSTs on the port 59278 of the server. The address of the server is given to the Eye-Fi card during configuration, by the Eye-Fi Manager. The path is either `/api/soap/eyefilm/v1` for plain XML (SOAP) messages, or `/api/soap/eyefilm/v1/upload` when a file is attached. In the latter case, a multipart content is sent.

When the Eye-Fi card wants to send an image to the server, it first sends a *StartSession* command, then a *GetPhotoStatus*, then an *UploadPhoto*, and finally, a *MarkLastPhotoInRoll*.

==StartSession==

The purpose of the *StartSession* command is to let the Eye-Fi card and the server authenticate each other, and to negociate the transfer mode.

Here is an example of a *StartSession* message sent by an Eye-Fi card:

{{{
<?xml version="1.0" encoding="UTF-8"?>
<SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ns1="EyeFi/SOAP/EyeFilm">
  <SOAP-ENV:Body>
    <ns1:StartSession>
      <macaddress>001856417729</macaddress>
      <cnonce>8744904b7ea202439631c67186690a1e</cnonce>
      <transfermode>2</transfermode>
      <transfermodetimestamp>1304505230</transfermodetimestamp>
    </ns1:StartSession>
  </SOAP-ENV:Body>
</SOAP-ENV:Envelope>
}}}

 * *macaddress* identifies the Eye-Fi card. The server will search in it's registry an Eye-Fi card with that MAC address. The registry contains all the information needed to continue the dialog. The upload key for instance.
 * *cnonce* is a random array of bytes that the Eye-Fi card has generated, and that is used by the authentication mechanism, as we will see below.
 * I don't know what *transfermode* and *transfermodetimestamp* are, Sceye-Fi simply sends back the same values to the Eye-Fi card.

The server will respond to such a message with a *StartSessionResponse*:

{{{
<?xml version="1.0" encoding="UTF-8"?>
<SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/">
  <SOAP-ENV:Body>
    <ns1:StartSessionResponse xmlns:ns1="http://localhost/api/soap/eyefilm">
      <credential>0d400f69ce6096c3771f9465c6123145</credential>
      <snonce>d5b2b8dd7a681cfb5320aaac2fd9bba4</snonce>
      <transfermode>2</transfermode>
      <transfermodetimestamp>1304505230</transfermodetimestamp>
      <upsyncallowed>false</upsyncallowed>
    </ns1:StartSessionResponse>
  </SOAP-ENV:Body>
</SOAP-ENV:Envelope>
}}}

 * *credential* is the MD5 digest of *macaddress*, *cnonce", and the upload key. It is used by the Eye-Fi card to authenticate the server.
 * *snonce* is a random array of bytes that the server has generated, and that is used by the authentication mechanism, as we will see below.
 * *transfermode* and *transfermodetimestamp* are copied from the request.
 * I don't know what *upsyncallowed* is, Sceye-Fi always set it to `false`.